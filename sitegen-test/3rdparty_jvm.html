<!DOCTYPE html>
<html lang="en">

<!--
  Copyright 2014 Pants project contributors (see CONTRIBUTORS.md).
  Licensed under the Apache License, Version 2.0 (see LICENSE).
-->

<head>
  <meta charset="utf-8" />
  <title>JVM 3rdparty Pattern</title>
  <link rel="stylesheet" href="s.css">
  <script src="s.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="logo.ico">
</head>

<body>

<div class="mainflow">
<nav class="breadcrumbs">
<ul>
<li><a href="index.html">Pants Build System</a>
<li><a href="3rdparty.html">Third-Party Dependencies</a>
<li><a href="3rdparty_jvm.html">JVM 3rdparty Pattern</a>
</ul>
</nav>

<nav class="pagetoc">
<ul>
<li class="toc-h1"><a href="#3rdpartyjvm">3rdparty/jvm ¶</a></li>
<li class="toc-h1"><a href="#your-codes-build-file">Your Code's BUILD File ¶</a></li>
<li class="toc-h1"><a href="#round-trip-dependencies">&quot;Round Trip&quot; Dependencies ¶</a></li>
<li class="toc-h1"><a href="#troubleshooting-a-jvm-dependencies-problem">Troubleshooting a JVM Dependencies Problem ¶</a></li>
<li class="toc-h1"><a href="#using-a-snapshot-jvm-dependency">Using a SNAPSHOT JVM Dependency ¶</a></li>
</ul>
</nav>

<!-- main content start -->
<body>
<!-- generated by pants! -->
<div class="h-plus-pilcrow"><h1 id="jvm-3rdparty-pattern">JVM 3rdparty Pattern<a class="pilcrow-link" href="#jvm-3rdparty-pattern"> ¶</a></h1></div>
<p>In general, we use the 3rdparty idiom \&lt;3rdparty&gt; to organize
dependencies on code from outside the source tree. This document
describes how to make this work for JVM (Java or Scala) code.</p>
<p>Your JVM code can pull in code written elsewhere. Pants uses
<a href="http://ant.apache.org/ivy/">Ivy</a>, a tool based on Maven's jar-sharing.
You should know the (<a href="http://maven.apache.org/guides/mini/guide-central-repository-upload.html">Maven/Ivy groupId, artifactId, and
version</a>)
you want to use.</p>
<p>The 3rdparty pattern described here eases avoiding diamond dependency
problems and version conflicts. If your code depends on artifacts <code>foo</code>
and <code>bar</code>; and if <code>foo</code> and <code>bar</code> depend on different versions of the
<code>baz</code> artifact; then some code will be linked together with a version of
<code>baz</code> it didn't "expect." Tracking versioned dependencies in one place
makes it easier to reason about them.</p>
<div class="h-plus-pilcrow"><h2 id="3rdpartyjvm">3rdparty/jvm<a class="pilcrow-link" href="#3rdpartyjvm"> ¶</a></h2></div>
<p><strong>The JVM part of 3rdparty is organized by org (Maven groupId)</strong> Under
there, see if there's already a <code>3rdparty/jvm/path/to/org/BUILD</code> file.
If there isn't, then you want to create one. E.g., to import
<code>com.sun.jersey-apache-client</code>, look in <code>3rdparty/jvm/com/sun</code> for a
likely-looking <code>BUILD</code> file--in this example,
<code>3rdparty/jvm/com/google/sun/jersey/BUILD</code>.</p>
<p>In the appropriate <code>BUILD</code> file, you want to find a bdict_jar_library
with the bdict_jars you want:</p>
<p>Here, the bdict_jar_librarys's name defines a target address that
other build targets can refer to. The bdict_jars refer to jars known to
your Ivy resolver.</p>
<p>If there's already a <code>jar</code> importing the code you want but with a
<em>different</em> version, then you probably want to talk to other folks in
your organization to agree on one version. (If there's already a <code>jar</code>
importing the code you want with the version you want, then great. Leave
it there.)</p>
<p>(You don't <em>need</em> a tree of <code>BUILD</code> files; you could instead have, e.g.,
one <code>3rdparty/jvm/BUILD</code> file. In a large organization, a tree can ease
some things. For example, <code>git log</code> quickly answers questions like "Who
set up this dependency? Who cares if I bump the version?")</p>
<p>Additionally, some families of jars have different groupId's but are
logically part of the same project, or need to have their rev's kept in
sync. For example, (<code>com.fasterxml.jackson.core</code>,
<code>com.fasterxml.jackson.dataformat</code>). Sometimes it makes sense to define
these in a single build file, such as
<code>3rdparty/jvm/com/fasterxml/jackson/BUILD</code> for the jackson family of
jars.</p>
<div class="h-plus-pilcrow"><h2 id="your-codes-build-file">Your Code's BUILD File<a class="pilcrow-link" href="#your-codes-build-file"> ¶</a></h2></div>
<p>To set up your code to import the external jar, you add a dependency to
the appropriate Java target[s] in your <code>BUILD</code> file and add <code>import</code>
statements in your Java code.</p>
<p>For example, your <code>BUILD</code> file might have</p>
<p>And your Java code might have:</p>
<div class="codehilite"><pre>import org.junit.Test;
</pre></div>
<div class="h-plus-pilcrow"><h2 id="round-trip-dependencies">"Round Trip" Dependencies<a class="pilcrow-link" href="#round-trip-dependencies"> ¶</a></h2></div>
<p>Depending on your workspace's relation with the rest of the world, you
might want to look out for "round trip" dependencies. You can publish an
artifact <em>near</em> generated from your workspace's source code and consume
a third-party artifact <em>far</em> that depends on <em>near</em>. If you're not
careful, you might depend on two versions of the <em>near</em> code: the local
source code and an artifact you published a while ago. When consuming
such third-party artifacts, exclude dependencies that "collide" with
source code and depend on local source:</p>
<div class="codehilite"><pre>jar_library(name='far',
  jars=[
    # exclude conflicting dep:
    jar(org='org.archie', name='far', rev='0.0.18').with_sources()
      .exclude(org='org.archimedes', name='near')
  ]
  dependencies=[
    # and re-include local version of source manually:
    'util/near',
  ]
)
</pre></div>
<div class="h-plus-pilcrow"><h2 id="troubleshooting-a-jvm-dependencies-problem">Troubleshooting a JVM Dependencies Problem<a class="pilcrow-link" href="#troubleshooting-a-jvm-dependencies-problem"> ¶</a></h2></div>
<p>If you're working in JVM (Java or Scala) and suspect you're pulling in
different versions of some package, you can dump your dependency "tree"
with versions with an Ivy resolve report. To generate a report for a
target such as the <code>hello/main</code> example:</p>
<div class="codehilite"><pre>$ ./pants goal resolve examples/src/java/com/pants/examples/hello/main --ivy-open
</pre></div>
<p>Ivy's report shows which things depend on which versions. You can see
which package is pulling in the package-version you didn't expect. (It
might not be clear which version you want to use; but at least you'll
know what's causing the problem.)</p>
<p><strong>If you notice a small number of wrong-version things,</strong> then in a JVM
target, you can depend on a <code>jar</code> that specifies a version and sets
<code>force=True</code> to <em>force</em> using that version:</p>
<div class="codehilite"><pre>scala_library(
  name = "loadtest",
  dependencies = [
    '3rdparty/bijection:bijection-scrooge',
    # our 3rdparty/BUILD still has 6.1.4 as the default version, but
    # finagle-[core|thrift] version 6.1.4 is superceded (evicted) by
    # version 6.4.1
    # Force inclusion of version 6.1.4, until we're bumped to finagle 6.4.1+
    jar(org='com.twitter', name='iago', rev='0.6.3', force=True),
    jar(org='com.twitter', name='finagle-core', rev='6.1.4', force=True),
    jar(org='com.twitter', name='finagle-thrift', rev='6.1.4', force=True),
  ],
  sources = ["LoadTestRecordProcessor.scala"])
</pre></div>
<p><strong>If you notice that one "foreign" dependency pulls in mostly wrong
things,</strong> tell Pants not to pull in its dependencies. In your
<code>3rdparty/.../BUILD</code> file, call the <code>jar</code>'s <code>intransitive</code> method; then
carefully add hand-picked versions:</p>
<div class="codehilite"><pre>jar_library(name="retro-naming-factory",
  jars=[
    jar(org='retro', name='retro-factory', rev='5.0.18').intransitive(),
  ],
  dependencies=[
    # Don't use retro's expected (old, incompatible) common-logging
    # version, yipe; use the same version we use everywhere else:
'3rdparty/jvm/common-logging',
  ])
</pre></div>
<p><strong>If you notice a small number of transitive dependencies to exclude</strong>
Rather than mark the <code>jar</code> intransitive, you can <code>exclude</code> some
transitive dependencies from JVM targets:</p>
<div class="codehilite"><pre>java_library(name = 'loadtest',
  dependencies = [
    '3rdparty/storm:storm',
  ],
  sources = globs('*.java'),
  excludes = [
    exclude('org.sonatype.sisu.inject', 'cglib')
  ]
)
</pre></div>
<p><strong>If you notice a missing dependency</strong>, check for a naming conflict.
When bringing in multiple jars with the same org, name, and version,
only the first reference will win, and subsequent references will be
silently discarded. One way that this can occur is with dependencies
that use a classifier to differentiate themselves. Consider this
example:</p>
<div class="codehilite"><pre>jar_library(name = 'stanford-corenlp',
  jars = [
    jar(org = 'edu.stanford.nlp', name = 'stanford-corenlp', rev = '3.3.1').with_sources(),
    jar(org = 'edu.stanford.nlp', name = 'stanford-corenlp', rev = '3.3.1', classifier='models')
  ]
)
</pre></div>
<p>In the above example, the
<code>edu.stanford.nlp.stanford-corenlp-3.3.1-models.jar</code> will be silently
skipped by pants. To bring both jars in, use the <code>.with_artifacts()</code>
method of the bdict_jar. Using this method, the above example would be
transformed into:</p>
<div class="codehilite"><pre>jar_library(name = 'stanford-corenlp',
  jars = [
    jar(org = 'edu.stanford.nlp', name = 'stanford-corenlp', rev = '3.3.1')
    .with_sources().with_artifact(classifier='models').with_artifact(classifier=''),
  ]
)
</pre></div>
<p>And as a result, both jars will now be brought into the target's
classpath.</p>
<div class="h-plus-pilcrow"><h2 id="using-a-snapshot-jvm-dependency">Using a SNAPSHOT JVM Dependency<a class="pilcrow-link" href="#using-a-snapshot-jvm-dependency"> ¶</a></h2></div>
<p>Sometimes your code depends on a buggy external JVM dependency. You
think you've fixed the external code, but want to test locally before
uploading it to make sure. To do this, in the <code>jar</code> dependency for the
artifact, specify the <code>url</code> attribute to point to the local file and
change the <code>rev</code>. If you are actively making changes to the dependency,
you can also use the <code>mutable</code> jar attribute to re-import the file each
time pants is run (otherwise, pants will cache it):</p>
<div class="codehilite"><pre>jar_library(name='checkstyle',
  jars = [
    jar(org='com.puppycrawl.tools', name='checkstyle', rev='5.5-SNAPSHOT',
        url='file:///Users/pantsdev/Src/checkstyle/checkstyle.jar',
        mutable=True),
  ],
)
</pre></div>
</body>
<!-- main content end -->

</div> <!-- end of mainflow -->

<nav class="bignav">
  <div class="bignav-logo">
    <a href="index.html">
      <img src="logo.ico" alt="[pantsbuild logo]">
    </a>
  </div>
  <form class="search" action="https://www.google.com/search">
  <input name="as_q" class="query">
  <input name="as_sitesearch" value="pantsbuild.github.io" type="hidden">
  <input value="Search" type=submit class="button">
  </form>

<div class="site-toc">
<ul>
<li class="toc-h1 ">
<a href="java/hello.html">HelloMain</a>
</li>
<li class="toc-h2 ">
<a href="testproject/page.html">Why does this page exist?</a>
</li>
<li class="toc-h1 ">
<a href="3rdparty.html">Third-Party Dependencies</a>
</li>
<li class="toc-h2 ">
<a href="3rdparty_py.html">Python 3rdparty Pattern</a>
</li>
<li class="toc-h2 toc-here">
JVM 3rdparty Pattern
</li>
<li class="toc-h1 ">
<a href="build_dictionary.html">Pants BUILD Dictionary</a>
</li>
<li class="toc-h1 ">
<a href="goals_reference.html">Pants Goals Reference</a>
</li>
</ul>
</div>
</nav>

<div class="ci-status">
<a href="https://travis-ci.org/pantsbuild/pants">
<img src="https://travis-ci.org/pantsbuild/pants.png?branch=master"
     alt="Are the tests passing?" title="Are the tests passing?"></a><br>
<a href="https://coveralls.io/r/pantsbuild/pants?branch=master">
<img src="https://coveralls.io/repos/pantsbuild/pants/badge.png?branch=master"
     alt="Test Coverage Status" title="Test Coverage Status"></a>
</div>

</body>
</html>

